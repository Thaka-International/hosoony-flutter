#!/bin/bash

# ๐งช ุณูุฑูุจุช ุงุฎุชุจุงุฑ APIs ุชููุงุฆู - ุชุทุจูู ุญุตููู ุงููุฑุขูู
# =====================================================

echo "๐งช ุจุฏุก ุงุฎุชุจุงุฑ APIs ุชููุงุฆู..."
echo "================================"

# ูุชุบูุฑุงุช ุงูุงุฎุชุจุงุฑ
BASE_URL="https://thakaa.me/api/v1"
TEST_RESULTS_FILE="api_test_results_$(date +%Y%m%d_%H%M%S).json"
SUCCESS_COUNT=0
FAILED_COUNT=0
TOTAL_TESTS=0

# ุฏุงูุฉ ูุงุฎุชุจุงุฑ API
test_api() {
    local method=$1
    local endpoint=$2
    local data=$3
    local description=$4
    local expected_status=$5
    
    TOTAL_TESTS=$((TOTAL_TESTS + 1))
    
    echo "๐ ุงุฎุชุจุงุฑ: $description"
    echo "   $method $endpoint"
    
    # ุจูุงุก ุงูุฃูุฑ curl
    local curl_cmd="curl -s -w '%{http_code}' -X $method"
    
    if [ "$method" = "POST" ] || [ "$method" = "PATCH" ]; then
        curl_cmd="$curl_cmd -H 'Content-Type: application/json'"
        if [ -n "$data" ]; then
            curl_cmd="$curl_cmd -d '$data'"
        fi
    fi
    
    curl_cmd="$curl_cmd '$BASE_URL$endpoint'"
    
    # ุชูููุฐ ุงูุงุฎุชุจุงุฑ
    local response=$(eval $curl_cmd)
    local status_code="${response: -3}"
    local body="${response%???}"
    
    # ุชุญููู ุงููุชูุฌุฉ
    if [ "$status_code" = "$expected_status" ]; then
        echo "   โ ูุฌุญ - ุงูุญุงูุฉ: $status_code"
        SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
        local result="SUCCESS"
    else
        echo "   โ ูุดู - ุงูุญุงูุฉ: $status_code (ูุชููุน: $expected_status)"
        FAILED_COUNT=$((FAILED_COUNT + 1))
        local result="FAILED"
    fi
    
    # ุญูุธ ุงููุชูุฌุฉ ูู ููู JSON
    echo "  {
    \"test\": \"$description\",
    \"method\": \"$method\",
    \"endpoint\": \"$endpoint\",
    \"expected_status\": $expected_status,
    \"actual_status\": $status_code,
    \"result\": \"$result\",
    \"response\": \"$body\",
    \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
  }," >> "$TEST_RESULTS_FILE"
}

# ุจุฏุก ููู ุงููุชุงุฆุฌ
echo "{
  \"test_suite\": \"ุญุตููู ุงููุฑุขูู API Tests\",
  \"base_url\": \"$BASE_URL\",
  \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
  \"tests\": [" > "$TEST_RESULTS_FILE"

echo ""
echo "๐ ุงุฎุชุจุงุฑ APIs ุงููุตุงุฏูุฉ..."
echo "=========================="

# ุงุฎุชุจุงุฑ ุชุณุฌูู ุงูุฏุฎูู ุจุงูุฅูููู
test_api "POST" "/auth/login" '{"email":"test@example.com","password":"password123"}' "ุชุณุฌูู ุงูุฏุฎูู ุจุงูุฅูููู" "401"

# ุงุฎุชุจุงุฑ ุฅุฑุณุงู ุฑูุฒ ุงูุชุญูู ููุฌูุงู
test_api "POST" "/phone-auth/send-code" '{"phone":"+966501234567"}' "ุฅุฑุณุงู ุฑูุฒ ุงูุชุญูู ููุฌูุงู" "422"

# ุงุฎุชุจุงุฑ ุงูุชุญูู ูู ุฑูุฒ ุงูุฌูุงู
test_api "POST" "/phone-auth/verify-code" '{"phone":"+966501234567","code":"123456"}' "ุงูุชุญูู ูู ุฑูุฒ ุงูุฌูุงู" "422"

# ุงุฎุชุจุงุฑ ุฅุนุงุฏุฉ ุฅุฑุณุงู ุงูุฑูุฒ
test_api "POST" "/phone-auth/resend-code" '{"phone":"+966501234567"}' "ุฅุนุงุฏุฉ ุฅุฑุณุงู ุฑูุฒ ุงูุชุญูู" "422"

echo ""
echo "๐ ุงุฎุชุจุงุฑ APIs ุงูููุงู ุงูููููุฉ..."
echo "================================"

# ุงุฎุชุจุงุฑ ุงูุญุตูู ุนูู ุงูููุงู ุงูููููุฉ
test_api "GET" "/students/1/daily-tasks" "" "ุงูุญุตูู ุนูู ุงูููุงู ุงูููููุฉ" "401"

# ุงุฎุชุจุงุฑ ุชุณููู ุงููููุฉ ุงูููููุฉ
test_api "POST" "/daily-logs/submit" '{"student_id":1,"task_id":1,"completed_at":"2025-01-01T10:00:00Z","notes":"ุชู ุฅูุฌุงุฒ ุงููููุฉ"}' "ุชุณููู ุงููููุฉ ุงูููููุฉ" "401"

# ุงุฎุชุจุงุฑ ุงูุญุตูู ุนูู ุณุฌู ุงูููุงู ุงูููููุฉ
test_api "GET" "/students/1/daily-logs" "" "ุงูุญุตูู ุนูู ุณุฌู ุงูููุงู ุงูููููุฉ" "401"

echo ""
echo "๐ฅ ุงุฎุชุจุงุฑ APIs ุงูุฑูููุงุช..."
echo "========================="

# ุงุฎุชุจุงุฑ ุชูููุฏ ุงูุฑูููุงุช
test_api "POST" "/classes/1/companions/generate" '{"target_date":"2025-01-01"}' "ุชูููุฏ ุงูุฑูููุงุช" "401"

# ุงุฎุชุจุงุฑ ููู ุงูุฑูููุงุช
test_api "PATCH" "/classes/1/companions/2025-01-01/lock" "" "ููู ุงูุฑูููุงุช" "401"

# ุงุฎุชุจุงุฑ ูุดุฑ ุงูุฑูููุงุช
test_api "POST" "/classes/1/companions/2025-01-01/publish" "" "ูุดุฑ ุงูุฑูููุงุช" "401"

# ุงุฎุชุจุงุฑ ุงูุญุตูู ุนูู ุฑูููุงุชู
test_api "GET" "/me/companions" "" "ุงูุญุตูู ุนูู ุฑูููุงุชู" "401"

echo ""
echo "๐ณ ุงุฎุชุจุงุฑ APIs ุงููุฏููุนุงุช..."
echo "=========================="

# ุงุฎุชุจุงุฑ ุงูุญุตูู ุนูู ุงูุงุดุชุฑุงู
test_api "GET" "/students/1/subscription" "" "ุงูุญุตูู ุนูู ุงูุงุดุชุฑุงู" "401"

# ุงุฎุชุจุงุฑ ุชุญุฏูุซ ุงูุงุดุชุฑุงู
test_api "PATCH" "/students/1/subscription" '{"plan":"premium","status":"active"}' "ุชุญุฏูุซ ุงูุงุดุชุฑุงู" "401"

# ุงุฎุชุจุงุฑ ุฅูุดุงุก ุฏูุนุฉ
test_api "POST" "/students/1/payments" '{"amount":100.0,"method":"bank_transfer","description":"ุฏูุนุฉ ุดูุฑูุฉ"}' "ุฅูุดุงุก ุฏูุนุฉ" "401"

# ุงุฎุชุจุงุฑ ุงูุญุตูู ุนูู ุฏูุนุงุช ุงูุทุงูุจ
test_api "GET" "/students/1/payments" "" "ุงูุญุตูู ุนูู ุฏูุนุงุช ุงูุทุงูุจ" "401"

echo ""
echo "๐ ุงุฎุชุจุงุฑ APIs ุงูุชูุงุฑูุฑ..."
echo "========================="

# ุงุฎุชุจุงุฑ ุงูุชูุฑูุฑ ุงููููู
test_api "GET" "/reports/daily/1" "" "ุงูุชูุฑูุฑ ุงููููู" "401"

# ุงุฎุชุจุงุฑ ุชูููุฏ ุงูุชูุฑูุฑ ุงูุดูุฑู
test_api "POST" "/reports/monthly/generate" '{"class_id":1,"month":1,"year":2025}' "ุชูููุฏ ุงูุชูุฑูุฑ ุงูุดูุฑู" "401"

# ุงุฎุชุจุงุฑ ุชุตุฏูุฑ ุงูุชูุฑูุฑ ุงูุดูุฑู
test_api "GET" "/reports/monthly/1/export" "" "ุชุตุฏูุฑ ุงูุชูุฑูุฑ ุงูุดูุฑู" "401"

echo ""
echo "๐ ุงุฎุชุจุงุฑ APIs ุงูุฅุดุนุงุฑุงุช..."
echo "=========================="

# ุงุฎุชุจุงุฑ ุงูุญุตูู ุนูู ุงูุฅุดุนุงุฑุงุช
test_api "GET" "/notifications" "" "ุงูุญุตูู ุนูู ุงูุฅุดุนุงุฑุงุช" "401"

# ุงุฎุชุจุงุฑ ุชุญุฏูุฏ ุงูุฅุดุนุงุฑ ูููุฑูุก
test_api "PATCH" "/notifications/1/read" "" "ุชุญุฏูุฏ ุงูุฅุดุนุงุฑ ูููุฑูุก" "401"

# ุงุฎุชุจุงุฑ ุฅุฑุณุงู ุฅุดุนุงุฑ ุชุฌุฑูุจู
test_api "POST" "/notifications/test" '{"title":"ุฅุดุนุงุฑ ุชุฌุฑูุจู","body":"ูุฐุง ุฅุดุนุงุฑ ุชุฌุฑูุจู"}' "ุฅุฑุณุงู ุฅุดุนุงุฑ ุชุฌุฑูุจู" "401"

echo ""
echo "๐ ุงุฎุชุจุงุฑ APIs ุงูุชููููุงุช..."
echo "=========================="

# ุงุฎุชุจุงุฑ ุงูุญุตูู ุนูู ุชููููุงุช ุงูุฌูุณุฉ
test_api "GET" "/sessions/1/evaluations" "" "ุงูุญุตูู ุนูู ุชููููุงุช ุงูุฌูุณุฉ" "401"

# ุงุฎุชุจุงุฑ ุฅูุดุงุก ุชูููู
test_api "POST" "/sessions/1/evaluations" '{"student_id":1,"score":85,"notes":"ุฃุฏุงุก ุฌูุฏ"}' "ุฅูุดุงุก ุชูููู" "401"

# ุงุฎุชุจุงุฑ ุงูุชูููู ุงููุฌูุน
test_api "POST" "/sessions/1/evaluations/bulk" '{"evaluations":[{"student_id":1,"score":85},{"student_id":2,"score":90}]}' "ุงูุชูููู ุงููุฌูุน" "401"

# ุงุฎุชุจุงุฑ ุงูุญุตูู ุนูู ุชูููู ูุญุฏุฏ
test_api "GET" "/evaluations/1" "" "ุงูุญุตูู ุนูู ุชูููู ูุญุฏุฏ" "401"

# ุงุฎุชุจุงุฑ ุงูุญุตูู ุนูู ุชุงุฑูุฎ ุฃุฏุงุก ุงูุทุงูุจ
test_api "GET" "/students/1/performance" "" "ุงูุญุตูู ุนูู ุชุงุฑูุฎ ุฃุฏุงุก ุงูุทุงูุจ" "401"

# ุงุฎุชุจุงุฑ ุงูุญุตูู ุนูู ููุฎุต ุฃุฏุงุก ุงููุตู
test_api "GET" "/classes/1/performance" "" "ุงูุญุตูู ุนูู ููุฎุต ุฃุฏุงุก ุงููุตู" "401"

# ุงุฎุชุจุงุฑ ุงูุญุตูู ุนูู ุชูุตูุงุช ุงูุทุงูุจ
test_api "GET" "/students/1/recommendations" "" "ุงูุญุตูู ุนูู ุชูุตูุงุช ุงูุทุงูุจ" "401"

echo ""
echo "๐ง ุงุฎุชุจุงุฑ APIs ุงูุนูููุงุช..."
echo "=========================="

# ุงุฎุชุจุงุฑ ุขุฎุฑ ุชุดุบูู ูููุฌุฏูู
test_api "GET" "/ops/scheduler/last-run" "" "ุขุฎุฑ ุชุดุบูู ูููุฌุฏูู" "200"

# ุฅููุงุก ููู ุงููุชุงุฆุฌ
echo "  ]
}" >> "$TEST_RESULTS_FILE"

echo ""
echo "๐ ููุฎุต ุงููุชุงุฆุฌ:"
echo "================"
echo "ุฅุฌูุงูู ุงูุงุฎุชุจุงุฑุงุช: $TOTAL_TESTS"
echo "ูุฌุญ: $SUCCESS_COUNT"
echo "ูุดู: $FAILED_COUNT"
echo "ูุนุฏู ุงููุฌุงุญ: $(( SUCCESS_COUNT * 100 / TOTAL_TESTS ))%"

echo ""
echo "๐ ุชู ุญูุธ ุงููุชุงุฆุฌ ูู: $TEST_RESULTS_FILE"

# ุชุญููู ุงููุชุงุฆุฌ
echo ""
echo "๐ ุชุญููู ุงููุชุงุฆุฌ:"
echo "================="

if [ $FAILED_COUNT -eq 0 ]; then
    echo "๐ ุฌููุน ุงูุงุฎุชุจุงุฑุงุช ูุฌุญุช!"
elif [ $SUCCESS_COUNT -gt $FAILED_COUNT ]; then
    echo "โ ูุนุธู ุงูุงุฎุชุจุงุฑุงุช ูุฌุญุช - ุงููุธุงู ูุนูู ุจุดูู ุฌูุฏ"
else
    echo "โ๏ธ  ุงูุนุฏูุฏ ูู ุงูุงุฎุชุจุงุฑุงุช ูุดูุช - ูุญุชุงุฌ ูุฑุงุฌุนุฉ"
fi

echo ""
echo "๐ ููุงุญุธุงุช ูููุฉ:"
echo "================"
echo "1. ูุนุธู APIs ุชุชุทูุจ ูุตุงุฏูุฉ (401 ูุชููุน)"
echo "2. APIs ุงูุนูููุงุช ุงูุนุงูุฉ ูุฌุจ ุฃู ุชุนูู (200 ูุชููุน)"
echo "3. ุฑุงุฌุน ููู ุงููุชุงุฆุฌ ููุชูุงุตูู ุงููุงููุฉ"
echo "4. ุงุณุชุฎุฏู ุฃุฏูุงุช ุงูุชุตุญูุญ ูู ุงูุชุทุจูู ูุงุฎุชุจุงุฑุงุช ุฃูุซุฑ ุชูุตููุงู"

echo ""
echo "โ ุงูุชูู ุงุฎุชุจุงุฑ APIs!"
echo "====================="











